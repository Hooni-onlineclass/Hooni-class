
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í™”ìƒ ìˆ˜ì—… ê´€ë¦¬</title>
  <script src="https://meet.mayfirst.org/external_api.js"></script>
  <script src="/jitsi_module.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fffaf0;
      padding: 40px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      color: #dc3545;
      margin-bottom: 30px;
    }
    input {
      padding: 10px;
      font-size: 16px;
      width: 300px;
      margin-right: 10px;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .class-item {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .class-item h3 {
      margin: 0 0 10px;
    }
    .class-item p {
      margin: 5px 0;
      color: #555;
    }
    .delete-btn {
      background-color: #dc3545;
      margin-left: 10px;
    }
    .delete-btn:hover {
      background-color: #c82333;
    }
    #jitsi {
      margin-top: 40px;
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>

  <h1>ğŸ› ï¸ í™”ìƒ ìˆ˜ì—… ê´€ë¦¬</h1>

  <input type="text" id="studentName" placeholder="í•™ìƒ ì´ë¦„ìœ¼ë¡œ í•„í„°ë§ (ì˜ˆ: ì§€ë¯¼)" />
  <button onclick="loadClasses()">ìˆ˜ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>

  <div id="classList"></div>
  <div id="jitsi"></div>
  <div id="fake-frame" style="position: absolute; top: 80px; left: 80px; width: 1200px; height: 750px; visibility: hidden;"></div>

  <script>
    window.loadClasses = async function () {
      const student = document.getElementById("studentName").value.trim();
      let url = "/api/video-class";
      url += `?createdBy=í›„ë‹ˆ${student ? `&student=${encodeURIComponent(student)}` : ""}`;

      try {
        const res = await fetch(url);
        const classes = await res.json();

        const container = document.getElementById("classList");
        container.innerHTML = "";
        document.getElementById("jitsi").innerHTML = "";

        if (classes.length === 0) {
          container.innerHTML = "<p>í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        classes.forEach(cls => {
          const item = document.createElement("div");
          item.className = "class-item";

          const date = new Date(cls.datetime).toLocaleString("ko-KR");

          item.innerHTML = `
            <h3>${cls.title}</h3>
            <p><strong>ì‹œê°„:</strong> ${date}</p>
            <p><strong>ë§í¬:</strong> <a href="${cls.link}" target="_blank">${cls.link}</a></p>
            <p><strong>ê³µê°œ ì—¬ë¶€:</strong> ${cls.isPublic ? "ì „ì²´ ê³µê°œ" : "ë¹„ê³µê°œ"}</p>
            <p><strong>ëŒ€ìƒ:</strong> ${cls.target === "all" ? "ì „ì²´ í•™ìƒ" : cls.students.join(", ")}</p>
            <button onclick="enterClass('${cls.link}', 'ê´€ë¦¬ì')">ì…ì¥</button>
            <button onclick="editClass('${cls._id}', '${cls.title}', '${cls.datetime}', '${cls.link}')">ìˆ˜ì •</button>
            <button class="delete-btn" onclick="deleteClass('${cls._id}')">ì‚­ì œ</button>
            <button class="delete-btn" onclick="deleteFullClassroomByLink('${cls.link}')">ì „ì²´ ì‚­ì œ</button>
          `;

          container.appendChild(item);
        });
      } catch (err) {
        console.error("ìˆ˜ì—… ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        alert("ìˆ˜ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };

    window.enterClass = function (link, displayName) {
      const roomName = link.replace("https://meet.jit.si/", "").trim();
      const jitsiArea = document.getElementById("jitsi");
      jitsiArea.innerHTML = "";

      if (typeof openJitsiLikeFrame === "function") {
        openJitsiLikeFrame(link);
      } else {
        alert("âŒ Jitsi ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    };

    window.deleteClass = async function (id) {
      const confirmDelete = confirm("ì •ë§ë¡œ ì´ ìˆ˜ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (!confirmDelete) return;

      try {
        const res = await fetch(`/api/video-class/${id}`, {
          method: "DELETE"
        });
        const result = await res.json();
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadClasses();
      } catch (err) {
        console.error("ì‚­ì œ ì‹¤íŒ¨:", err);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };

    window.editClass = function (id, title, datetime, link) {
      const newTitle = prompt("ìƒˆ ìˆ˜ì—… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", title);
      if (!newTitle) return;

      const newDatetime = prompt("ìƒˆ ìˆ˜ì—… ì‹œê°„ (ISO í˜•ì‹) ì…ë ¥:", datetime);
      if (!newDatetime) return;

      const newLink = prompt("ìƒˆ ìˆ˜ì—… ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", link);
      if (!newLink) return;

      const updated = {
        title: newTitle,
        datetime: newDatetime,
        link: newLink
      };

      fetch(`/api/video-class/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated)
      })
      .then(res => res.json())
      .then(data => {
        alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadClasses();
      })
      .catch(err => {
        console.error("ìˆ˜ì • ì‹¤íŒ¨:", err);
        alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    };

    // âœ… í†µí•© ì‚­ì œ í•¨ìˆ˜ ì¶”ê°€
    async function deleteFullClassroomByLink(link) {
      if (!confirm(`ì´ ìˆ˜ì—…ë°©ê³¼ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${link}`)) return;

      try {
        const videoRes = await fetch(`/api/video-class?link=${encodeURIComponent(link)}`);
        const videoClasses = await videoRes.json();
        for (const cls of videoClasses) {
          await fetch(`/api/video-class/${cls._id}`, { method: "DELETE" });
        }

        const scheduleRes = await fetch(`/api/schedule?user=í›„ë‹ˆ`);
        const schedules = await scheduleRes.json();
        const related = schedules.filter(s => s.url === link);
        for (const item of related) {
          await fetch(`/api/schedule/${item._id}`, { method: "DELETE" });
        }

        const settingsList = JSON.parse(localStorage.getItem("roomSettingsList") || "[]");
        const updated = settingsList.filter(s => s.link !== link);
        localStorage.setItem("roomSettingsList", JSON.stringify(updated));

        const current = JSON.parse(localStorage.getItem("roomSettings") || "{}");
        if (current.link === link) {
          localStorage.removeItem("roomSettings");
          localStorage.removeItem("generatedRoomLink");
        }

        alert("âœ… ìˆ˜ì—…ë°©, ì¼ì •, ì„¤ì •ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadClasses();
      } catch (err) {
        console.error("âŒ ì‚­ì œ ì‹¤íŒ¨:", err);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    window.addEventListener("DOMContentLoaded", loadClasses);
  </script>

</body>
</html>
