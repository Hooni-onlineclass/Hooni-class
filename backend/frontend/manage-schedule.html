
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìˆ˜ì—… ì¼ì • ê´€ë¦¬</title>
  <style>
    body {
      font-family: Arial;
      padding: 40px;
      max-width: 700px;
      margin: auto;
      background: #f9f9f9;
    }
    h1 {
      color: #007bff;
      margin-bottom: 30px;
    }
    form, .filters {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 30px;
    }
    input, button {
      padding: 10px;
      font-size: 14px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    .delete, .edit {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .edit {
      background-color: #28a745;
    }
    .edit:hover {
      background-color: #218838;
    }
    .delete:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>
  <h1>ğŸ› ï¸ ìˆ˜ì—… ì¼ì • ê´€ë¦¬</h1>

  <div class="filters">
    <input type="text" id="keywordFilter" placeholder="ì œëª© ë˜ëŠ” ë§í¬ í‚¤ì›Œë“œë¡œ í•„í„°" />
    <input type="date" id="dateFilter" />
    <button onclick="renderScheduleList()">í•„í„° ì ìš©</button>
  </div>

  <form id="scheduleForm">
    <input type="text" id="title" placeholder="ìˆ˜ì—… ì œëª©" required />
    <input type="datetime-local" id="datetime" required />
    <input type="url" id="link" placeholder="ìˆ˜ì—…ë°© ë§í¬ (ì„ íƒ)" />
    <button type="submit">ì¼ì • ì €ì¥</button>
  </form>

  <ul id="scheduleList"></ul>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const API_BASE = "https://hooni-class.onrender.com";
      const form = document.getElementById("scheduleForm");
      const list = document.getElementById("scheduleList");
      const titleInput = document.getElementById("title");
      const datetimeInput = document.getElementById("datetime");
      const linkInput = document.getElementById("link");
      const keywordInput = document.getElementById("keywordFilter");
      const dateInput = document.getElementById("dateFilter");

      const currentUser = "í›„ë‹ˆ";
      let editingId = null;

      async function loadSchedule() {
        try {
          const res = await fetch(`${API_BASE}/api/schedule?user=${encodeURIComponent(currentUser)}`);
          return await res.json();
        } catch (err) {
          console.error("ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
          return [];
        }
      }

      async function saveSchedule(data) {
        try {
          const res = await fetch(`${API_BASE}/api/schedule`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
          return await res.json();
        } catch (err) {
          console.error("ì¼ì • ì €ì¥ ì‹¤íŒ¨:", err);
        }
      }

      async function updateSchedule(id, data) {
        try {
          const res = await fetch(`${API_BASE}/api/schedule/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
          return await res.json();
        } catch (err) {
          console.error("ì¼ì • ìˆ˜ì • ì‹¤íŒ¨:", err);
        }
      }

      async function deleteSchedule(id) {
        try {
          await fetch(`${API_BASE}/api/schedule/${id}`, { method: "DELETE" });
        } catch (err) {
          console.error("ì‚­ì œ ì‹¤íŒ¨:", err);
        }
      }

      window.handleDelete = async function (id) {
        if (confirm("ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          await deleteSchedule(id);
          renderScheduleList();
        }
      };

      window.handleEdit = function (id, title, start, url) {
        editingId = id;
        titleInput.value = title;
        datetimeInput.value = start.slice(0, 16);
        linkInput.value = url;
      };

      form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const title = titleInput.value.trim();
        const datetime = datetimeInput.value;
        const link = linkInput.value.trim();

        if (!title || !datetime) {
          alert("ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const scheduleData = {
          title,
          start: datetime,
          url: link || "",
          user: currentUser
        };

        if (editingId) {
          await updateSchedule(editingId, scheduleData);
          editingId = null;
        } else {
          await saveSchedule(scheduleData);
        }

        renderScheduleList();
        form.reset();
      });

      async function renderScheduleList() {
        const schedules = await loadSchedule();
        const keyword = keywordInput.value.trim().toLowerCase();
        const dateFilter = dateInput.value;

        const filtered = schedules.filter(item => {
          const matchKeyword =
            !keyword ||
            item.title.toLowerCase().includes(keyword) ||
            (item.url && item.url.toLowerCase().includes(keyword));
          const matchDate =
            !dateFilter || new Date(item.start) >= new Date(dateFilter);
          return matchKeyword && matchDate;
        });

        list.innerHTML = "";

        if (filtered.length === 0) {
          list.innerHTML = "<li>ì¡°ê±´ì— ë§ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
          return;
        }

        filtered.forEach((item) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <span>${item.title} - ${new Date(item.start).toLocaleString()} ${item.url ? `(<a href="${item.url}" target="_blank">ë§í¬</a>)` : ""}</span>
            <div class="actions">
              <button class="edit" onclick="handleEdit('${item._id}', '${item.title}', '${item.start}', '${item.url || ""}')">ìˆ˜ì •</button>
              <button class="delete" onclick="handleDelete('${item._id}')">ì‚­ì œ</button>
              ${item.url ? `<button class="delete" onclick="deleteFullClassroomByLink('${item.url}')">ì „ì²´ ì‚­ì œ</button>` : ""}
            </div>
          `;
          list.appendChild(li);
        });
      }

      window.deleteFullClassroomByLink = async function (link) {
        if (!confirm(`ì´ ìˆ˜ì—…ë°©ê³¼ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${link}`)) return;

        try {
          const videoRes = await fetch(`${API_BASE}/api/video-class?link=${encodeURIComponent(link)}`);
          const videoClasses = await videoRes.json();
          for (const cls of videoClasses) {
            await fetch(`${API_BASE}/api/video-class/${cls._id}`, { method: "DELETE" });
          }

          const scheduleRes = await fetch(`${API_BASE}/api/schedule?user=${encodeURIComponent(currentUser)}`);
          const schedules = await scheduleRes.json();
          const related = schedules.filter(s => s.url === link);
          for (const item of related) {
            await fetch(`${API_BASE}/api/schedule/${item._id}`, { method: "DELETE" });
          }

          const settingsList = JSON.parse(localStorage.getItem("roomSettingsList") || "[]");
          const updated = settingsList.filter(s => s.link !== link);
          localStorage.setItem("roomSettingsList", JSON.stringify(updated));

          const current = JSON.parse(localStorage.getItem("roomSettings") || "{}");
          if (current.link === link) {
            localStorage.removeItem("roomSettings");
            localStorage.removeItem("generatedRoomLink");
          }

          alert("âœ… ìˆ˜ì—…ë°©, ì¼ì •, ì„¤ì •ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          renderScheduleList();
        } catch (err) {
          console.error("âŒ ì‚­ì œ ì‹¤íŒ¨:", err);
          alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      };

      renderScheduleList();
    });
  </script>
</body>
</html>
