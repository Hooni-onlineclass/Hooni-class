
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìˆ˜ì—…ë°© ì„¤ì •</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      padding: 40px;
      max-width: 700px;
      margin: auto;
    }
    h1 {
      color: #007bff;
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .delete-btn {
      background-color: #dc3545;
    }
    .delete-btn:hover {
      background-color: #c82333;
    }
    .note {
      font-size: 14px;
      color: #555;
      margin-top: -15px;
      margin-bottom: 20px;
    }
  </style>
</head><body>
  <h1>ğŸ› ï¸ ìˆ˜ì—…ë°© ì„¤ì •</h1>

  <label for="roomTitle">ìˆ˜ì—… ì œëª©</label>
  <input type="text" id="roomTitle" placeholder="ì˜ˆ: ì˜ì–´íšŒí™” ì¤‘ê¸‰ë°˜" />

  <label for="roomDatetime">ìˆ˜ì—… ì‹œì‘ ì‹œê°„</label>
  <input type="datetime-local" id="roomDatetime" />

  <label for="roomLink">ìˆ˜ì—…ë°© ë§í¬</label>
  <input type="text" id="roomLink" placeholder="ì˜ˆ: https://meet.jit.si/hunienglishclass" />

  <label for="isPublic">ê³µê°œ ì—¬ë¶€</label>
  <select id="isPublic">
    <option value="true">âœ… ê³µê°œ</option>
    <option value="false">âŒ ë¹„ê³µê°œ</option>
  </select>

  <label for="target">ëŒ€ìƒ í•™ìƒ</label>
  <select id="target">
    <option value="all">ì „ì²´ í•™ìƒ</option>
    <option value="specific">íŠ¹ì • í•™ìƒ</option>
  </select>

  <div id="studentBox" style="display:none;">
    <label for="studentList">í•™ìƒ ì´ë¦„ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
    <textarea id="studentList" placeholder="ì˜ˆ: ì§€ë¯¼, íƒœí˜•, ì •êµ­"></textarea>
    <div class="note">â€» íŠ¹ì • í•™ìƒë§Œ ì…ì¥ ê°€ëŠ¥í•˜ê²Œ í•˜ë ¤ë©´ ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.</div>
  </div>

  <button onclick="saveSettings()">ì„¤ì • ì €ì¥</button>
<button onclick="deleteFullClassroomByLink(document.getElementById('roomLink').value)" class="delete-btn">ğŸ—‘ï¸ ìˆ˜ì—…ë°© ì‚­ì œ</button>


  <script>
    document.getElementById("target").addEventListener("change", function () {
      const value = this.value;
      document.getElementById("studentBox").style.display = value === "specific" ? "block" : "none";
    });

    window.addEventListener("DOMContentLoaded", () => {
      const settings = JSON.parse(localStorage.getItem("roomSettings"));
      const generatedLink = localStorage.getItem("generatedRoomLink");

      if (settings && settings.link) {
        document.getElementById("roomTitle").value = settings.title || "";
        document.getElementById("roomDatetime").value = settings.datetime || "";
        document.getElementById("roomLink").value = settings.link;
        document.getElementById("isPublic").value = settings.isPublic ? "true" : "false";
        document.getElementById("target").value = settings.target;
        if (settings.target === "specific") {
          document.getElementById("studentBox").style.display = "block";
          document.getElementById("studentList").value = settings.students.join(", ");
        }
      } else if (generatedLink) {
        document.getElementById("roomLink").value = generatedLink;
      }
    });

    async function saveSettings() {
      const title = document.getElementById("roomTitle").value.trim();
      const datetime = document.getElementById("roomDatetime").value;
      const link = document.getElementById("roomLink").value.trim();
      const isPublic = document.getElementById("isPublic").value === "true";
      const target = document.getElementById("target").value;
      const students = document.getElementById("studentList").value.trim();

      if (!title || !datetime || !link.startsWith("https://meet.jit.si/")) {
        alert("ì œëª©, ì‹œê°„, ë§í¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const settings = {
        title,
        datetime,
        link,
        isPublic,
        target,
        students: students.split(",").map(s => s.trim()).filter(s => s !== ""),
        createdBy: "í›„ë‹ˆ"
      };

      localStorage.setItem("roomSettings", JSON.stringify(settings));

      try {
        await fetch("/api/video-class", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(settings)
        });

        await fetch("/api/schedule", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title,
            start: datetime,
            url: link,
            user: "í›„ë‹ˆ"
          })
        });

        alert("ìˆ˜ì—…ë°©ì´ ì €ì¥ë˜ê³  ì¼ì •í‘œì—ë„ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch (err) {
        console.error("ì €ì¥ ì‹¤íŒ¨:", err);
        alert("ì„œë²„ì— ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function deleteFullClassroomByLink(link) {
      if (!link || !link.startsWith("https://")) {
        alert("ì‚­ì œí•  ìˆ˜ì—…ë°© ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const confirmDelete = confirm(
        `í˜„ì¬ ìˆ˜ì—…ë°© ë§í¬ëŠ”:\n\n${link}\n\nì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œí•˜ë©´ ë‹¤ì‹œ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
      );

      if (!confirmDelete) return;

      try {
        const videoRes = await fetch(`/api/video-class?link=${encodeURIComponent(link)}`);
        const videoClasses = await videoRes.json();
        for (const cls of videoClasses) {
          await fetch(`/api/video-class/${cls._id}`, { method: "DELETE" });
        }

        const scheduleRes = await fetch(`/api/schedule?user=í›„ë‹ˆ`);
        const schedules = await scheduleRes.json();
        const related = schedules.filter(s => s.url === link);
        for (const item of related) {
          await fetch(`/api/schedule/${item._id}`, { method: "DELETE" });
        }

        const settingsList = JSON.parse(localStorage.getItem("roomSettingsList") || "[]");
        const updated = settingsList.filter(s => s.link !== link);
        localStorage.setItem("roomSettingsList", JSON.stringify(updated));

        const current = JSON.parse(localStorage.getItem("roomSettings") || "{}");
        if (current.link === link) {
          localStorage.removeItem("roomSettings");
          localStorage.removeItem("generatedRoomLink");
        }

        document.getElementById("roomTitle").value = "";
        document.getElementById("roomDatetime").value = "";
        document.getElementById("roomLink").value = "";
        document.getElementById("studentList").value = "";

        alert("âœ… ìˆ˜ì—…ë°©, ì¼ì •, ì„¤ì •ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch (err) {
        console.error("âŒ ì‚­ì œ ì‹¤íŒ¨:", err);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }
  </script>
</body>
</html>

